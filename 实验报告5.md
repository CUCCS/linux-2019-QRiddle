# 实验五：WEB服务器

## 实验环境
- Ubuntu 18.04 Server 64bit

## 实验要求
- [x] 基本要求
- [x] 安全加固要求
- [x] VERYNGINX配置要求

## 实验过程
### 安装
- nginx [Ubuntu18.04搭建nginx服务器](https://blog.csdn.net/fengfeng0328/article/details/82828224)

  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/nginx.png)

- verynginx [alexazhou/VeryNginx](https://github.com/alexazhou/VeryNginx/blob/master/readme_zh.md)

    ```bash
    git clone https://github.com/alexazhou/VeryNginx.git
    python install.py install
    apt install libpcre3 libpcre3-dev libssl1.0-dev build-essential
    ```
    
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/verynginx_finish.png)
    
    ```bash
    #error 
	  adduser nginx
    ```
    
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/verynginx_error.png)
  
    ```bash
    #修改/opt/verynginx/openresty/nginx/conf/nginx.conf配置文件
	  sudo vim /opt/verynginx/openresty/nginx/conf/nginx.conf
	  #修改server监听端口为8080
	  #在macOS的hosts文件添加192.168.56.101  vn.sec.cuc.edu.cn
    ```
    
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/hosts.png)
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/verynginx.png)

- wordpress [How To Install WordPress with LEMP on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-install-wordpress-with-lemp-on-ubuntu-18-04#step-1-—-creating-a-mysql-database-and-user-for-wordpress)

    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wordpress.png)


- dvwa [How to Install and Configure DVWA Lab on Ubuntu 18.04 server](https://kifarunix.com/how-to-setup-damn-vulnerable-web-app-lab-on-ubuntu-18-04-server/)

    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa.png)
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa1.png)
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa2.png)

### 基本要求

- 修改nginx配置，wordpress监听80端口，dvwa监听5566端口
- 在verynginx中配置端口转发
	- Basic_Matcher
  
	    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/verynginx_agent_matcher.png)
  
	- Backend_Proxy Pass
  
	    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/verynginx_agent_proxypass.png)
    
- 配置文件

  [nginx](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/conf/nginx.conf)

  [verynginx](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/conf/verynginx.conf)

- 使用Wordpress搭建的站点对外提供访问的地址为： https://wp.sec.cuc.edu.cn 和 http://wp.sec.cuc.edu.cn

  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wp：8080.png)![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wp_https.png)

- 使用[Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)搭建的站点对外提供访问的地址为： http://dvwa.sec.cuc.edu.cn。

  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa：8080.png)

### 安全加固要求

- 使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的友好错误提示信息页面-1

	- Basic_Matcher
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/ip_matcher.png)
    
	- Basic_Response
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/ip_response.png)
    
	- Custom Action_Filter
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/ip_filter.png)
    
	- 结果
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/ip_result.png)


- DVWA只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-2
	- Basic_Matcher
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_whiteip_matcher.png)
    
	- Basic_Response
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_whiteip_response.png)
    
	- Custom Action_Filter
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_whiteip_filter.png)
    
	- 结果
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_whiteip_result.png)



- 在不升级Wordpress版本的情况下，通过定制VeryNginx的访问控制策略规则，热修复WordPress < 4.7.1 - Username Enumeration
	- Basic_Matcher
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wp_matcher.png)
  
	- Basic_Response
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wp_response.png)
  
	- Custom Action_Filter
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wp_filter.png)
  
	- 结果
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/wp_result.png)



- 通过配置VeryNginx的Filter规则实现对Damn Vulnerable Web Application (DVWA)的SQL注入实验在低安全等级条件下进行防护
	- Basic_Matcher
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_matcher.png)
  
	- Basic_Response
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_response.png)
  
	- Custom Action_Filter
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_filter.png)
  
	- 结果
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/dvwa_result.png)
  


### VERYNGINX配置要求

- VeryNginx的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-3

	- Basic_Matcher
   
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/vn_matcher.png)
	
  - Basic_Response
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/vn_response.png)
  
  - Custom Action_Filter
    
    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/vn_filter.png)
  
  - 结果
  
	  ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/vn_result.png)


 - 通过定制VeryNginx的访问控制策略规则实现：
 
	  - 限制DVWA站点的单IP访问速率为每秒请求数 < 50
	  - 限制Wordpress站点的单IP访问速率为每秒请求数 < 20
    - 超过访问频率限制的请求直接返回自定义错误提示信息页面-4
	  
      ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/speed.png)
      ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/speed_limit.png)
  
    - 禁止curl访问
  
	    ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/curt.png)
      ![](https://github.com/CUCCS/linux-2019-QRiddle/blob/homework5/img/curt_stop.png)

 
 
## 参考文献

[Ubuntu18.04搭建nginx服务器](https://blog.csdn.net/fengfeng0328/article/details/82828224)

[CUCCS/2015-linux-public-kjAnny](https://github.com/CUCCS/2015-linux-public-kjAnny)

[CUCCS/linux-2019-jackcily](https://github.com/CUCCS/linux-2019-jackcily/blob/job5/job5/实验5.md)

[CUCCS/linux-2019-FLYFLY-H](https://github.com/CUCCS/linux-2019-FLYFLY-H/blob/linux_exp5/exp5/实验报告五.md)
